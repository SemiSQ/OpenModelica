#
# Makefile for omc
#
# David Kågedal <x97davka@ida.liu.se>
#
# $Id$
#

ANTLR_HOME = @antlrhome@

ANTLR_INCP = -I@antlrinc@
ANTLR_LIBP = -L@antlrlib@
LIBSOCKET = @LIBSOCKET@

USE_CORBA = @USE_CORBA@
CORBAHOME = @CORBAHOME@

SHELL	= /bin/sh
CC	= gcc
CFLAGS	= $(USE_CORBA)
RMLHOME	= @rmlhome@
RMLINC  = -I$(RMLHOME)/include/plain

EXEEXT  = @EXEEXT@

srcdir = ..
top_builddir = ../..
builddir_bin=$(top_builddir)/build/bin
builddir_lib=$(top_builddir)/build/lib
builddir_inc=$(top_builddir)/build/include
builddir_doc=$(top_builddir)/build/doc
include $(srcdir)/Makefile.common

CORBALIB=`mico-config --libs`

ifdef USE_CORBA
 CORBALIBS=$(CORBALIB)
else
 CORBALIBS=
endif

LDFLAGS = -lm -L$(RMLHOME)/lib/plain -lrml $(ANTLR_LIBP) -lantlr $(LIBSOCKET) $(CORBALIBS) -ldl -llpsolve55

ifdef QTHOME
PLTPKGFLAGS = -L../../build/lib -lsendData -L$(QTHOME)/lib -lQtNetwork -lQtCore -lQtGui
else
PLTPKGFLAGS = -L../../build/lib -lsendData
endif

PROG = omc
RMLC	= @rmlc_bin@
RML	= $(RMLHOME)/bin/rml
RMLCFLAGS = -Wr,-ftrace



SUBDIRS	= $(srcdir)/runtime $(srcdir)/absyn_builder $(srcdir)/modpar

all : $(ALLMO) $(SRCSIGX) subdirs $(PROG)


.SUFFIXES:
.SUFFIXES: .o .mo .h
.PHONY: all subdirs $(SUBDIRS) report vctarget absyn_subdir clean reallyclean

SRCHSRCDIR = $(SRCH:%.h=$(srcdir)/%.h)


$(ALLMO): %.mo : $(srcdir)/%.mo
	cp $< $@

$(SRCO): %.o : %.c %.h
	$(RMLC) $(RMLCFLAGS) -c $<

$(SRCC): %.c : %.mo
	$(RMLC) $(RMLCFLAGS) +C $<

$(SRCHSRCDIR) : $(srcdir)/%.h : %.h
	cp $< $@

$(SRCH): %.h : %.mo
	$(RMLC) $(RMLCFLAGS) -c $<

$(SRCSIGX): %.sigx : %.mo
	$(srcdir)/rml2sig/rmldep-new.sh $<
	@touch $@

vctarget: $(SRCC) absyn_subdir


absyn_subdir:
	(cd $(srcdir)/absyn_builder && $(MAKE) vctarget)

$(PROG): $(SRCO) $(AST) $(RTOBJ) $(top_builddir)/c_runtime/sendData/*.cpp
	g++ -O3 -o $(PROG)$(EXEEXT) $(SRCO) $(AST) $(RTOBJ) $(LDFLAGS) $(PLTPKGFLAGS)

subdirs: $(SRCHSRCDIR) $(SUBDIRS)

$(SUBDIRS):
	$(MAKE) -C $@

clean:
	for d in $(SUBDIRS); do \
		(cd $$d && $(MAKE) clean) \
	done
	(cd $(srcdir) && $(RM) $(SRCH))
	$(RM) -f $(SRCO) $(SRCC) $(SRCH) $(PROG)$(EXEEXT) *~ $(ALLMO:.mo=.srz)

reallyclean: clean
	$(RM) -f $(ALLMO) $(ALLMO:.mo=.sig) $(ALLMO:.mo=.sigx) $(ALLMO:.mo=.srz) $(PROG)$(EXEEXT) 

# don't remove these files after intermediate build steps
.PRECIOUS: Makefile $(ALLMO)

Makefile: Makefile.in
	$(top_builddir)/config.status Makefile


## dependencies
include $(srcdir)/.depend
