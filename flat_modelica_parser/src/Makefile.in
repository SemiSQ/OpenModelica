
top_builddir= ../..
builddir_bin=$(top_builddir)/build/bin
builddir_lib=$(top_builddir)/build/lib
builddir_inc=$(top_builddir)/build/include
builddir_doc=$(top_builddir)/build/doc


CC=gcc
CXX=g++
AR=ar -r

MODELICA_PARSER=$(top_builddir)/modelica_parser/src

ANTLR_HOME=@antlrhome@

INCLUDES=-I@antlrinc@ -I$(MODELICA_PARSER)

LIBP=-L@antlrlib@

CFLAGS =-O3 -Wall $(INCLUDES)
CXXFLAGS = $(CFLAGS)

ANTLRFLAGS=
ANTLR = java -cp $(top_builddir)/@omc_antlr_jar@ antlr.Tool

LIB = $(LIBP) -lantlr

lexergen= flat_modelica_lexer.cpp flat_modelica_lexer.hpp \
	  modelicaTokenTypes.hpp modelicaTokenTypes.txt

parsergen= flat_modelica_parser.cpp flat_modelica_parser.hpp \
	   flat_modelica_parserTokenTypes.hpp flat_modelica_parserTokenTypes.txt

lexersrcs=$(filter %.cpp,$(lexergen))
parsersrcs=$(filter %.cpp,$(parsergen))

lexerobjs=$(lexersrcs:.cpp=.o)
parserobjs=$(parsersrcs:.cpp=.o)

helperobjs =  parse_tree_dumper.o token_names.o

OBJS += $(lexerobjs) $(parserobjs)
#$(helperobjs)

all: libmodelica_parser.a
.PHONY: lexeronce parseronce

vctarget: $(lexergen) $(parsergen)

libmodelica_parser.a: $(OBJS)
	$(AR) $@ $(OBJS)

lexeronce: flat_modelica_lexer.g
	$(ANTLR) $(ANTLRFLAGS) $<

parseronce: flat_modelica_parser.g $(lexergen)
	$(ANTLR) $(ANTLRFLAGS) $<

$(lexergen): lexeronce

$(parsergen): lexeronce parseronce

.c.o:
	$(CC) $(CFLAGS) -c $<

.cpp.o:
	$(CXX) $(CXXFLAGS) -c $<

test: test.cpp libflat_modelica_parser.a parse_tree_dumper.o
	$(CXX) -o test test.cpp libflat_modelica_parser.a  \
	$(MODELICA_PARSER)/parse_tree_dumper.o $(LIB) $(INCLUDES)

depend: $(DFILES)

clean:
	-rm -f *.o *~ core *.core *.a

reallyclean: clean
	-rm -f $(lexergen) $(parsergen)

flat_modelica_lexer.o:flat_modelica_lexer.cpp flat_modelica_lexer.hpp
flat_modelica_parser.o:flat_modelica_parser.cpp flat_modelica_parser.hpp
#token_names.o:token_names.cpp
parse_tree_dumper.o:
	cd $(MODELICA_PARSER) && make && cd $(top_builddir)/flat_modelica_parser/src


#parse_tree_dumper.cpp: parse_tree_dumper.cpp
#include $(DFILES)

