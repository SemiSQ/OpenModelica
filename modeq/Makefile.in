#
# Makefile for modeq
#
# David Kågedal <x97davka@ida.liu.se>
#
# $Id$
#

ARCH = $(shell uname)
ANTLR_HOME = @antlrhome@

ANTLR_INCP = -I@antlrinc@
ANTLR_LIBP = -L@antlrlib@

SHELL	= /bin/sh
CC	= gcc
CFLAGS	= 
RMLHOME	= @rmlhome@
RML	= @rmlc_bin@ -g
RMLINC  = -I$(RMLHOME)/include/plain

LDFLAGS=
ifeq ($(ARCH),CYGWIN_NT-5.1)
LDFLAGS = -L$(RMLHOME)/lib/plain $(ANTLR_LIBP) -lrml -lm -lantlr
endif

ifeq ($(ARCH),CYGWIN_NT-5.0)
LDFLAGS = -L$(RMLHOME)/lib/plain $(ANTLR_LIBP) -lrml -lm -lantlr
endif

ifeq ($(strip $(LDFLAGS)),)
LDFLAGS = -L$(RMLHOME)/lib/plain $(ANTLR_LIBP) -lrml -lm -lantlr -lsocket -lnsl 
endif

PROG	= modeq
AST	= absyn_builder/absyn_builder.a
RTOBJ   = runtime/systemimpl.o ../c_runtime/libc_runtime.a runtime/rtopts.o runtime/socketimpl.o runtime/printimpl.o

SRCRML= absyn.rml \
	algorithm.rml \
	builtin.rml \
	classinf.rml \
	classloader.rml \
	codegen.rml \
	connect.rml \
	dae.rml \
	debug.rml \
	dump.rml \
	dumpgraphviz.rml \
	env.rml \
	exp.rml \
	explode.rml \
	graphviz.rml \
	inst.rml \
	interactive.rml \
	lookup.rml \
	main.rml \
	mod.rml \
	modutil.rml \
	prefix.rml \
	staticexp.rml \
	types.rml \
	util.rml \
	values.rml

SRCC=	$(SRCRML:.rml=.c)
SRCH=	$(SRCRML:.rml=.h)
SRCO=	$(SRCC:.c=.o)

#SUBDIRS= ast runtime
SUBDIRS	= runtime absyn_builder

.SUFFIXES:
.SUFFIXES: .o .rml .h
.PHONY: all subdirs report

.rml.o:
	$(RML) -c $<

.rml.h:
	$(RML) -c $<

all : $(SRCO) subdirs $(PROG)

test:
	@(cd testsuite ; make)

$(PROG): $(SRCO) $(AST) $(RTOBJ)
	g++ -o $(PROG) $(SRCO) $(AST) $(RTOBJ) $(LDFLAGS)


ast/libast.a:
	@(cd ast ; $(MAKE) libast.a)

subdirs:
	@for d in $(SUBDIRS); do \
		(cd $$d ; $(MAKE)) \
	done

clean:
	@for d in $(SUBDIRS); do \
		(cd $$d ; $(MAKE) clean) \
	done
	$(RM) $(SRCO) $(SRCC) $(SRCH) $(PROG) *~

reallyclean: clean

report:
	@(cd report ; $(MAKE))

depend:
	$(RM) .dep
	for f in $(SRCRML); do \
	  echo `echo $$f | sed "s/\.rml/.o/"`: $$f `sed -n -e 's/.*with "\(.*\)\.rml".*/\1.rml/p' < $$f | egrep -v 'nothing'` >> .dep ; \
	done
	mv Makefile.in Makefile.in.save
	sed -n -e "1,/^## dependencies/p" < Makefile.in.save > Makefile.in
	cat .dep >> Makefile.in
	$(RM) .dep Makefile.in.save

## dependencies
absyn.o: absyn.rml debug.rml dump.rml util.rml print.rml
algorithm.o: algorithm.rml exp.rml types.rml explode.rml print.rml
builtin.o: builtin.rml absyn.rml explode.rml env.rml exp.rml types.rml classinf.rml debug.rml print.rml
classinf.o: classinf.rml explode.rml print.rml absyn.rml
classloader.o: classloader.rml absyn.rml system.rml lookup.rml interactive.rml
codegen.o: codegen.rml dae.rml print.rml dump.rml debug.rml absyn.rml algorithm.rml classinf.rml exp.rml modutil.rml types.rml util.rml
connect.o: connect.rml exp.rml staticexp.rml dae.rml dump.rml print.rml
dae.o: dae.rml absyn.rml exp.rml algorithm.rml types.rml rtopts.rml graphviz.rml dump.rml print.rml util.rml
debug.o: debug.rml rtopts.rml dump.rml print.rml
dump.o: dump.rml absyn.rml interactive.rml debug.rml classinf.rml rtopts.rml print.rml util.rml
dumpgraphviz.o: dumpgraphviz.rml absyn.rml debug.rml graphviz.rml classinf.rml dump.rml
env.o: env.rml absyn.rml values.rml explode.rml types.rml classinf.rml exp.rml dump.rml graphviz.rml dae.rml print.rml
exp.o: exp.rml absyn.rml rtopts.rml util.rml print.rml
explode.o: explode.rml absyn.rml dump.rml debug.rml print.rml
graphviz.o: graphviz.rml
inst.o: inst.rml classinf.rml connect.rml dae.rml debug.rml env.rml exp.rml explode.rml mod.rml prefix.rml types.rml util.rml interactive.rml absyn.rml algorithm.rml builtin.rml dump.rml lookup.rml modutil.rml rtopts.rml staticexp.rml values.rml print.rml
interactive.o: interactive.rml absyn.rml explode.rml dae.rml types.rml values.rml dump.rml debug.rml rtopts.rml util.rml parse.rml prefix.rml mod.rml env.rml lookup.rml classinf.rml exp.rml inst.rml staticexp.rml modutil.rml codegen.rml print.rml system.rml
lookup.o: lookup.rml classinf.rml types.rml absyn.rml exp.rml env.rml explode.rml parse.rml debug.rml dump.rml inst.rml mod.rml prefix.rml print.rml builtin.rml
main.o: main.rml absyn.rml modutil.rml parse.rml dump.rml dumpgraphviz.rml explode.rml dae.rml inst.rml interactive.rml rtopts.rml debug.rml codegen.rml socket.rml print.rml
mod.o: mod.rml absyn.rml dae.rml env.rml exp.rml prefix.rml explode.rml types.rml staticexp.rml values.rml dump.rml print.rml
modutil.o: modutil.rml absyn.rml dae.rml exp.rml algorithm.rml rtopts.rml util.rml print.rml
prefix.o: prefix.rml absyn.rml exp.rml env.rml lookup.rml util.rml print.rml
staticexp.o: staticexp.rml absyn.rml exp.rml explode.rml types.rml env.rml values.rml classinf.rml interactive.rml dump.rml print.rml system.rml lookup.rml debug.rml inst.rml codegen.rml modutil.rml dae.rml
types.o: types.rml classinf.rml absyn.rml exp.rml values.rml explode.rml dump.rml debug.rml print.rml
util.o: util.rml
values.o: values.rml exp.rml print.rml system.rml
